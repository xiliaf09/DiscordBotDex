#!/usr/bin/env python3
"""
Script de migration PostgreSQL pour corriger la structure de la base de donn√©es
"""

import os
import psycopg2
from psycopg2.extensions import ISOLATION_LEVEL_AUTOCOMMIT

def migrate_postgresql_database():
    """Migre la base de donn√©es PostgreSQL vers la nouvelle structure"""
    
    # R√©cup√©rer l'URL de la base de donn√©es depuis les variables d'environnement
    database_url = os.getenv('DATABASE_URL')
    
    if not database_url:
        print("‚ùå Variable d'environnement DATABASE_URL non trouv√©e")
        return False
    
    if not database_url.startswith('postgresql://'):
        print("‚ùå DATABASE_URL n'est pas une URL PostgreSQL")
        return False
    
    print(f"üîß Migration de la base de donn√©es PostgreSQL...")
    print(f"üìã URL: {database_url[:20]}...")
    
    try:
        # Connexion √† la base de donn√©es
        conn = psycopg2.connect(database_url)
        conn.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)
        c = conn.cursor()
        
        # V√©rifier la structure actuelle de active_snipes
        c.execute("""
            SELECT column_name, data_type 
            FROM information_schema.columns 
            WHERE table_name = 'active_snipes'
            ORDER BY ordinal_position;
        """)
        
        columns = c.fetchall()
        print(f"üìã Colonnes actuelles dans active_snipes: {columns}")
        
        # Si la table a l'ancienne structure (fid, amount, timestamp)
        if len(columns) == 3 and any('fid' in col[0] for col in columns):
            print("üîÑ Migration de l'ancienne structure vers la nouvelle...")
            
            # Supprimer l'ancienne table
            c.execute("DROP TABLE IF EXISTS active_snipes CASCADE")
            print("‚úÖ Ancienne table active_snipes supprim√©e")
            
            # Cr√©er la table tracked_addresses si elle n'existe pas
            c.execute("""
                CREATE TABLE IF NOT EXISTS tracked_addresses (
                    address VARCHAR(42) PRIMARY KEY,
                    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            """)
            print("‚úÖ Table tracked_addresses cr√©√©e/v√©rifi√©e")
            
            # Cr√©er la nouvelle table active_snipes
            c.execute("""
                CREATE TABLE active_snipes (
                    id SERIAL PRIMARY KEY,
                    tracked_address VARCHAR(42) NOT NULL,
                    snipe_amount_eth DECIMAL(18,8) NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    is_active BOOLEAN DEFAULT TRUE,
                    FOREIGN KEY (tracked_address) REFERENCES tracked_addresses(address)
                )
            """)
            print("‚úÖ Nouvelle table active_snipes cr√©√©e")
            
        elif len(columns) == 0:
            print("üîÑ Cr√©ation des tables manquantes...")
            
            # Cr√©er la table tracked_addresses
            c.execute("""
                CREATE TABLE IF NOT EXISTS tracked_addresses (
                    address VARCHAR(42) PRIMARY KEY,
                    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            """)
            print("‚úÖ Table tracked_addresses cr√©√©e")
            
            # Cr√©er la table active_snipes
            c.execute("""
                CREATE TABLE active_snipes (
                    id SERIAL PRIMARY KEY,
                    tracked_address VARCHAR(42) NOT NULL,
                    snipe_amount_eth DECIMAL(18,8) NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    is_active BOOLEAN DEFAULT TRUE,
                    FOREIGN KEY (tracked_address) REFERENCES tracked_addresses(address)
                )
            """)
            print("‚úÖ Table active_snipes cr√©√©e")
            
        else:
            print("‚úÖ Structure d√©j√† correcte")
        
        # V√©rifier la nouvelle structure
        c.execute("""
            SELECT column_name, data_type 
            FROM information_schema.columns 
            WHERE table_name = 'active_snipes'
            ORDER BY ordinal_position;
        """)
        
        new_columns = c.fetchall()
        print(f"üìã Nouvelle structure active_snipes: {new_columns}")
        
        # Tester l'insertion d'une adresse track√©e
        test_address = "0x38B3890A0C0983bE825E353b809A96aC4fA0077e"
        c.execute("INSERT INTO tracked_addresses (address) VALUES (%s) ON CONFLICT (address) DO NOTHING", (test_address,))
        print(f"‚úÖ Adresse test ajout√©e: {test_address}")
        
        # Tester l'insertion d'un snipe
        c.execute("""
            INSERT INTO active_snipes 
            (tracked_address, snipe_amount_eth, is_active) 
            VALUES (%s, %s, %s)
        """, (test_address, 0.001, True))
        print(f"‚úÖ Snipe test ajout√©: {test_address} - 0.001 ETH")
        
        # V√©rifier les donn√©es
        c.execute("SELECT * FROM tracked_addresses WHERE address = %s", (test_address,))
        tracked = c.fetchone()
        print(f"üìã Adresse track√©e: {tracked}")
        
        c.execute("SELECT * FROM active_snipes WHERE tracked_address = %s", (test_address,))
        snipes = c.fetchone()
        print(f"üìã Snipe actif: {snipes}")
        
        conn.close()
        
        print("üéâ Migration PostgreSQL termin√©e avec succ√®s !")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur lors de la migration PostgreSQL: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    print("üöÄ D√©but de la migration PostgreSQL...")
    success = migrate_postgresql_database()
    if success:
        print("\n‚ú® La base de donn√©es PostgreSQL est maintenant pr√™te !")
        print("üéØ La commande !setupsnipe devrait maintenant fonctionner.")
    else:
        print("\n‚ùå √âchec de la migration PostgreSQL.")
