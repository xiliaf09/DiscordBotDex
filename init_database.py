#!/usr/bin/env python3
"""
Script pour initialiser la base de donn√©es avec la bonne structure
"""

import sqlite3
import os

def init_database():
    """Initialise la base de donn√©es avec la structure correcte"""
    print("üöÄ Initialisation de la base de donn√©es...")
    
    try:
        # Supprimer l'ancienne base de donn√©es si elle existe
        if os.path.exists('snipes.db'):
            os.remove('snipes.db')
            print("üóëÔ∏è Ancienne base de donn√©es supprim√©e")
        
        # Cr√©er une nouvelle base de donn√©es
        conn = sqlite3.connect('snipes.db')
        c = conn.cursor()
        
        # Cr√©er la table tracked_addresses
        c.execute("""
            CREATE TABLE tracked_addresses (
                address TEXT PRIMARY KEY,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("‚úÖ Table tracked_addresses cr√©√©e")
        
        # Cr√©er la table active_snipes
        c.execute("""
            CREATE TABLE active_snipes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                tracked_address TEXT NOT NULL,
                snipe_amount_eth REAL NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                is_active BOOLEAN DEFAULT 1,
                FOREIGN KEY (tracked_address) REFERENCES tracked_addresses(address)
            )
        """)
        print("‚úÖ Table active_snipes cr√©√©e")
        
        # Cr√©er les autres tables n√©cessaires
        c.execute("""
            CREATE TABLE banned_fids (
                fid TEXT PRIMARY KEY,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("‚úÖ Table banned_fids cr√©√©e")
        
        c.execute("""
            CREATE TABLE whitelisted_fids (
                fid TEXT PRIMARY KEY,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("‚úÖ Table whitelisted_fids cr√©√©e")
        
        c.execute("""
            CREATE TABLE keyword_whitelist (
                keyword TEXT PRIMARY KEY,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("‚úÖ Table keyword_whitelist cr√©√©e")
        
        c.execute("""
            CREATE TABLE bot_preferences (
                key TEXT PRIMARY KEY,
                value TEXT,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("‚úÖ Table bot_preferences cr√©√©e")
        
        # Tester l'insertion d'une adresse track√©e
        test_address = "0x38B3890A0C0983bE825E353b809A96aC4fA0077e"
        c.execute("INSERT INTO tracked_addresses (address) VALUES (?)", (test_address,))
        print(f"‚úÖ Adresse test ajout√©e: {test_address}")
        
        # Tester l'insertion d'un snipe
        c.execute("""
            INSERT INTO active_snipes 
            (tracked_address, snipe_amount_eth, is_active) 
            VALUES (?, ?, ?)
        """, (test_address, 0.001, 1))
        print(f"‚úÖ Snipe test ajout√©: {test_address} - 0.001 ETH")
        
        # V√©rifier les donn√©es
        c.execute("SELECT * FROM tracked_addresses")
        tracked = c.fetchall()
        print(f"üìã Adresses track√©es: {tracked}")
        
        c.execute("SELECT * FROM active_snipes")
        snipes = c.fetchall()
        print(f"üìã Snipes actifs: {snipes}")
        
        conn.commit()
        conn.close()
        
        print("üéâ Base de donn√©es initialis√©e avec succ√®s !")
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur lors de l'initialisation: {e}")
        return False

if __name__ == "__main__":
    success = init_database()
    if success:
        print("\n‚ú® La base de donn√©es est pr√™te pour la commande setupsnipe !")
    else:
        print("\n‚ùå √âchec de l'initialisation de la base de donn√©es.")
