#!/usr/bin/env python3
"""
Script pour corriger la base de donn√©es de production
Ce script peut √™tre ex√©cut√© directement sur le serveur
"""

import os
import sys

def fix_production_database():
    """Corrige la base de donn√©es de production"""
    
    print("üöÄ Correction de la base de donn√©es de production...")
    
    # V√©rifier si nous sommes sur le serveur de production
    if not os.getenv('DATABASE_URL'):
        print("‚ùå Variable d'environnement DATABASE_URL non trouv√©e")
        print("üí° Assurez-vous d'ex√©cuter ce script sur le serveur de production")
        return False
    
    try:
        import psycopg2
        from psycopg2.extensions import ISOLATION_LEVEL_AUTOCOMMIT
        
        database_url = os.getenv('DATABASE_URL')
        print(f"üìã Connexion √† la base de donn√©es PostgreSQL...")
        
        # Connexion √† la base de donn√©es
        conn = psycopg2.connect(database_url)
        conn.set_isolation_level(ISOLATION_LEVEL_AUTOCOMMIT)
        c = conn.cursor()
        
        # V√©rifier la structure actuelle
        c.execute("""
            SELECT column_name, data_type 
            FROM information_schema.columns 
            WHERE table_name = 'active_snipes'
            ORDER BY ordinal_position;
        """)
        
        columns = c.fetchall()
        print(f"üìã Structure actuelle: {columns}")
        
        # Si la table a l'ancienne structure
        if len(columns) == 3 and any('fid' in col[0] for col in columns):
            print("üîÑ Migration de l'ancienne structure...")
            
            # Supprimer l'ancienne table
            c.execute("DROP TABLE IF EXISTS active_snipes CASCADE")
            print("‚úÖ Ancienne table supprim√©e")
            
            # Cr√©er la table tracked_addresses
            c.execute("""
                CREATE TABLE IF NOT EXISTS tracked_addresses (
                    address VARCHAR(42) PRIMARY KEY,
                    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            """)
            print("‚úÖ Table tracked_addresses cr√©√©e")
            
            # Cr√©er la nouvelle table active_snipes
            c.execute("""
                CREATE TABLE active_snipes (
                    id SERIAL PRIMARY KEY,
                    tracked_address VARCHAR(42) NOT NULL,
                    snipe_amount_eth DECIMAL(18,8) NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    is_active BOOLEAN DEFAULT TRUE,
                    FOREIGN KEY (tracked_address) REFERENCES tracked_addresses(address)
                )
            """)
            print("‚úÖ Nouvelle table active_snipes cr√©√©e")
            
        elif len(columns) == 0:
            print("üîÑ Cr√©ation des tables manquantes...")
            
            # Cr√©er la table tracked_addresses
            c.execute("""
                CREATE TABLE IF NOT EXISTS tracked_addresses (
                    address VARCHAR(42) PRIMARY KEY,
                    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            """)
            print("‚úÖ Table tracked_addresses cr√©√©e")
            
            # Cr√©er la table active_snipes
            c.execute("""
                CREATE TABLE active_snipes (
                    id SERIAL PRIMARY KEY,
                    tracked_address VARCHAR(42) NOT NULL,
                    snipe_amount_eth DECIMAL(18,8) NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    is_active BOOLEAN DEFAULT TRUE,
                    FOREIGN KEY (tracked_address) REFERENCES tracked_addresses(address)
                )
            """)
            print("‚úÖ Table active_snipes cr√©√©e")
            
        else:
            print("‚úÖ Structure d√©j√† correcte")
        
        # V√©rifier la nouvelle structure
        c.execute("""
            SELECT column_name, data_type 
            FROM information_schema.columns 
            WHERE table_name = 'active_snipes'
            ORDER BY ordinal_position;
        """)
        
        new_columns = c.fetchall()
        print(f"üìã Nouvelle structure: {new_columns}")
        
        conn.close()
        
        print("üéâ Base de donn√©es de production corrig√©e !")
        return True
        
    except ImportError:
        print("‚ùå psycopg2 non install√©. Installation...")
        os.system("pip install psycopg2-binary")
        return fix_production_database()
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        return False

if __name__ == "__main__":
    success = fix_production_database()
    if success:
        print("\n‚ú® La base de donn√©es est maintenant pr√™te !")
        print("üéØ Red√©marrez votre bot pour que les changements prennent effet.")
    else:
        print("\n‚ùå √âchec de la correction.")
        sys.exit(1)
