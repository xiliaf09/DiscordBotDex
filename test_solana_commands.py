#!/usr/bin/env python3
"""
Script de test pour les commandes Discord Solana Twilio
"""

import asyncio
import logging
import config
from unittest.mock import Mock, AsyncMock

# Configuration du logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class MockCtx:
    """Mock Discord context pour les tests"""
    def __init__(self):
        self.author = Mock()
        self.author.mention = "@TestUser"
        self.author.display_name = "TestUser"
        self.channel = Mock()
        self.channel.mention = "#test-channel"
        self.send = AsyncMock()
        self.send.return_value = Mock()

class MockBot:
    """Mock Bot pour les tests"""
    def __init__(self):
        self.cogs = {}

async def test_solana_cog_commands():
    """Test des commandes du SolanaCog"""
    
    logger.info("üß™ Test des commandes SolanaCog")
    
    try:
        # Import du SolanaCog
        from solana_cog import SolanaCog
        
        # Cr√©er des mocks
        mock_bot = MockBot()
        mock_ctx = MockCtx()
        
        # Cr√©er une instance du SolanaCog
        solana_cog = SolanaCog(mock_bot)
        
        # Test 1: Statut initial
        logger.info("üìä Test du statut initial...")
        await solana_cog.solana_call_status(mock_ctx)
        
        # Test 2: Activation des appels
        logger.info("üü¢ Test d'activation des appels...")
        await solana_cog.solana_call_enable(mock_ctx)
        assert solana_cog.solana_call_enabled == True
        logger.info("‚úÖ Appels activ√©s avec succ√®s")
        
        # Test 3: Configuration du seuil
        logger.info("‚öôÔ∏è Test de configuration du seuil...")
        await solana_cog.solana_call_set_threshold(mock_ctx, 5.0)
        assert solana_cog.solana_call_min_amount == 5.0
        logger.info("‚úÖ Seuil configur√© avec succ√®s")
        
        # Test 4: Statut apr√®s configuration
        logger.info("üìä Test du statut apr√®s configuration...")
        await solana_cog.solana_call_status(mock_ctx)
        
        # Test 5: D√©sactivation des appels
        logger.info("üî¥ Test de d√©sactivation des appels...")
        await solana_cog.solana_call_disable(mock_ctx)
        assert solana_cog.solana_call_enabled == False
        logger.info("‚úÖ Appels d√©sactiv√©s avec succ√®s")
        
        # Test 6: Test d'erreur (montant n√©gatif)
        logger.info("‚ùå Test d'erreur (montant n√©gatif)...")
        await solana_cog.solana_call_set_threshold(mock_ctx, -1.0)
        
        logger.info("üéâ Tous les tests des commandes sont pass√©s avec succ√®s !")
        return True
        
    except Exception as e:
        logger.error(f"‚ùå Erreur lors des tests des commandes: {e}")
        return False

async def test_configuration_integration():
    """Test de l'int√©gration avec la configuration"""
    
    logger.info("üîß Test de l'int√©gration avec la configuration")
    
    try:
        from solana_cog import SolanaCog
        
        # Cr√©er des mocks
        mock_bot = MockBot()
        solana_cog = SolanaCog(mock_bot)
        
        # V√©rifier que les valeurs initiales correspondent √† la config
        logger.info(f"üìã Configuration initiale:")
        logger.info(f"   SOLANA_CALL_ENABLED: {config.SOLANA_CALL_ENABLED}")
        logger.info(f"   SOLANA_CALL_MIN_AMOUNT: {config.SOLANA_CALL_MIN_AMOUNT}")
        
        logger.info(f"üìã Valeurs SolanaCog:")
        logger.info(f"   solana_call_enabled: {solana_cog.solana_call_enabled}")
        logger.info(f"   solana_call_min_amount: {solana_cog.solana_call_min_amount}")
        
        # Test de modification des valeurs
        solana_cog.solana_call_enabled = False
        solana_cog.solana_call_min_amount = 10.0
        
        logger.info(f"üìã Valeurs apr√®s modification:")
        logger.info(f"   solana_call_enabled: {solana_cog.solana_call_enabled}")
        logger.info(f"   solana_call_min_amount: {solana_cog.solana_call_min_amount}")
        
        logger.info("‚úÖ Test d'int√©gration r√©ussi !")
        return True
        
    except Exception as e:
        logger.error(f"‚ùå Erreur lors du test d'int√©gration: {e}")
        return False

async def test_bot_integration():
    """Test de l'int√©gration avec le bot principal"""
    
    logger.info("ü§ñ Test de l'int√©gration avec le bot principal")
    
    try:
        # Mock du bot avec SolanaCog
        from solana_cog import SolanaCog
        
        mock_bot = MockBot()
        solana_cog = SolanaCog(mock_bot)
        mock_bot.cogs['SolanaCog'] = solana_cog
        
        # Simuler la logique de send_solana_notification
        solana_cog_found = None
        for cog in mock_bot.cogs.values():
            if hasattr(cog, 'solana_call_enabled'):
                solana_cog_found = cog
                break
        
        if solana_cog_found:
            call_enabled = solana_cog_found.solana_call_enabled
            min_amount = solana_cog_found.solana_call_min_amount
            
            logger.info(f"üìû Param√®tres r√©cup√©r√©s du SolanaCog:")
            logger.info(f"   call_enabled: {call_enabled}")
            logger.info(f"   min_amount: {min_amount}")
            
            logger.info("‚úÖ Test d'int√©gration bot r√©ussi !")
            return True
        else:
            logger.error("‚ùå SolanaCog non trouv√© dans les cogs")
            return False
        
    except Exception as e:
        logger.error(f"‚ùå Erreur lors du test d'int√©gration bot: {e}")
        return False

async def main():
    """Fonction principale de test"""
    
    logger.info("üöÄ D√©marrage des tests des commandes Solana Twilio")
    logger.info("=" * 60)
    
    # Test 1: Commandes SolanaCog
    success1 = await test_solana_cog_commands()
    logger.info("")
    
    # Test 2: Int√©gration configuration
    success2 = await test_configuration_integration()
    logger.info("")
    
    # Test 3: Int√©gration bot
    success3 = await test_bot_integration()
    logger.info("")
    
    # R√©sultats
    logger.info("=" * 60)
    if success1 and success2 and success3:
        logger.info("üéâ Tous les tests sont pass√©s avec succ√®s !")
        logger.info("‚úÖ Les commandes Discord Solana Twilio sont pr√™tes √† √™tre utilis√©es")
    else:
        logger.error("üí• Certains tests ont √©chou√©")
        logger.error("‚ùå V√©rifiez les erreurs ci-dessus")
    
    logger.info("=" * 60)

if __name__ == "__main__":
    asyncio.run(main())
